<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <style>
        /* Admin Login Styles */
        .login-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
        .google-btn { background-color: #4285F4; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 4px; cursor: pointer; margin-top: 20px; }
        .hidden { display: none !important; }
        
        /* Event Type Selector */
        select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; background: white; }

        /* Mini Map for Details View */
        #details-map { height: 250px; width: 100%; border-radius: 8px; border: 1px solid #ccc; margin-top: 10px; z-index: 0; }
        
        /* Edit Controls */
        .edit-controls { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #eee; }
        .disabled-input { background-color: #f0f0f0; color: #666; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container">

    <div id="view-login" class="login-wrapper">
        <h1>Admin Portal</h1>
        <p>Restricted Access</p>
        <button id="loginBtn" class="google-btn">Sign in with Google</button>
        <p id="auth-error" style="color:red; margin-top:15px; font-weight:bold;"></p>
    </div>

    <div id="view-dashboard" class="hidden">
        <div class="flex-row" style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:20px;">
            <h1 style="margin:0;">Admin Dashboard</h1>
            <button class="secondary" id="logoutBtn" style="width:auto; padding:5px 15px; font-size:0.8em;">Logout</button>
        </div>
        
        <div class="tabs">
            <div id="tab-create" class="tab active" onclick="switchTab('create')">Create Event</div>
            <div id="tab-history" class="tab" onclick="switchTab('history'); loadHistory()">Event History</div>
        </div>

        <div id="view-create">
            <input type="text" id="eventName" placeholder="Event Name (e.g., Physics 101)">
            
            <label style="display:block; margin-top:10px; color:#666; font-weight:bold;">Event Type:</label>
            <select id="eventType">
                <option value="internal">Internal (NITC Email Only)</option>
                <option value="external">External (Open to All)</option>
            </select>

            <div id="map"></div>
            
            <div class="flex-row">
                <label>Geofence Radius: <strong id="radiusVal">50</strong> m</label>
            </div>
            <input type="range" id="radiusSlider" min="10" max="500" value="50">
            
            <button id="createBtn">Create Event & Generate QR</button>

            <div id="qr-result" class="hidden" style="text-align:center; margin-top:20px; background:#f9f9f9; padding:20px; border:2px dashed #ddd; border-radius:10px;">
                <h3 style="margin-top:0; color:#27ae60;">‚úÖ Event Created!</h3>
                <img id="qr-image" src="" alt="Generating QR..." style="width: 200px; height: 200px; border: 1px solid #ccc; padding: 5px; background: white;">
                <p style="margin-bottom:5px; margin-top:15px; font-weight:bold;">Scan or Share:</p>
                <a id="share-link" href="#" target="_blank" style="word-break: break-all; color:#3498db; text-decoration:underline;">Link</a>
            </div>
        </div>

        <div id="view-history" class="hidden">
            <h3>Past Events</h3>
            <div id="events-list"><p>Loading...</p></div>
        </div>

        <div id="view-details" class="hidden">
            <div class="flex-row">
                <button class="secondary" style="width: auto;" onclick="switchTab('history')">‚Üê Back</button>
                <div style="display:flex; align-items:center;">
                    <span style="font-size:0.9em; margin-right:5px;">Accepting Responses:</span>
                    <label class="switch">
                        <input type="checkbox" id="toggle-active">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="edit-controls">
                <div class="flex-row">
                    <h3 style="margin:0;">Event Settings</h3>
                    <button id="editBtn" style="width:auto; padding:5px 15px; background:#f39c12;">‚úèÔ∏è Edit</button>
                    <button id="saveBtn" class="hidden" style="width:auto; padding:5px 15px; background:#27ae60;">üíæ Save</button>
                </div>

                <label>Event Name:</label>
                <input type="text" id="edit-name" disabled class="disabled-input">

                <label>Event Type:</label>
                <select id="edit-type" disabled class="disabled-input">
                    <option value="internal">Internal (NITC Only)</option>
                    <option value="external">External (Open)</option>
                </select>

                <label>Geofence Location (Drag pin to update):</label>
                <div id="details-map"></div> <div class="flex-row" style="margin-top:10px;">
                    <label>Radius: <strong id="edit-radius-val">50</strong> m</label>
                </div>
                <input type="range" id="edit-radius" min="10" max="500" value="50" disabled>
            </div>

            <hr>

            <h3>Stats & Data</h3>
            <p>Total Attendees: <strong id="count-val">0</strong></p>
            <button onclick="downloadCSV()">Download CSV</button>
            <ul id="attendee-list"><li>Loading...</li></ul>
            
            <button class="danger" onclick="deleteCurrentEvent()">Delete Event</button>
        </div>
    </div>
</div>

<script type="module">
    import { db, auth, collection, addDoc, getDocs, query, orderBy, where, doc, updateDoc, deleteDoc, writeBatch, Timestamp, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from './script.js';

    const ALLOWED_ADMIN = "maddula_m241070ee@nitc.ac.in";
    let map, marker, circle; // Main Create Map
    let detailsMap, detailsMarker, detailsCircle; // Mini Edit Map

    // --- AUTH ---
    onAuthStateChanged(auth, (user) => {
        if (user && user.email === ALLOWED_ADMIN) {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
            setTimeout(initCreateMap, 500);
        } else if (user) {
            alert("Access Denied"); signOut(auth);
        } else {
            document.getElementById('view-login').classList.remove('hidden');
            document.getElementById('view-dashboard').classList.add('hidden');
        }
    });

    document.getElementById('loginBtn').addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));
    document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth).then(() => window.location.reload()));

    // --- CREATE MAP ---
    function initCreateMap() {
        if(map) return;
        let startLoc = [40.7128, -74.0060]; 
        map = L.map('map').setView(startLoc, 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        marker = L.marker(startLoc, {draggable: true}).addTo(map);
        circle = L.circle(startLoc, { color: 'red', radius: 50 }).addTo(map);
        marker.on('drag', (e) => circle.setLatLng(e.target.getLatLng()));
        
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => {
                const loc = [p.coords.latitude, p.coords.longitude];
                map.setView(loc, 18); marker.setLatLng(loc); circle.setLatLng(loc);
            });
        }
    }
    
    document.getElementById('radiusSlider').addEventListener('input', (e) => {
        document.getElementById('radiusVal').innerText = e.target.value;
        circle.setRadius(e.target.value);
    });

    // --- CREATE LOGIC ---
    document.getElementById('createBtn').addEventListener('click', async () => {
        const name = document.getElementById('eventName').value;
        const type = document.getElementById('eventType').value;
        if(!name) return alert("Enter Name");
        
        try {
            const docRef = await addDoc(collection(db, "events"), {
                name: name, eventType: type,
                latitude: marker.getLatLng().lat, longitude: marker.getLatLng().lng,
                radius: parseInt(document.getElementById('radiusSlider').value),
                isActive: true, createdAt: Timestamp.now()
            });

            const baseUrl = window.location.href.replace('admin.html', 'index.html');
            const url = `${baseUrl}?id=${docRef.id}`;
            document.getElementById('qr-image').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
            document.getElementById('share-link').href = url;
            document.getElementById('share-link').innerText = url;
            document.getElementById('qr-result').classList.remove('hidden');
        } catch(e) { alert("Error: " + e.message); }
    });

    // --- HISTORY LIST ---
    window.loadHistory = async () => {
        const listDiv = document.getElementById('events-list');
        listDiv.innerHTML = "Loading...";
        const q = query(collection(db, "events"), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);
        listDiv.innerHTML = "";
        
        snap.forEach(docSnap => {
            const data = docSnap.data();
            const typeBadge = data.eventType === 'internal' ? 'üîí Internal' : 'üåç External';
            const div = document.createElement('div');
            div.className = 'event-card';
            div.innerHTML = `<div><b>${data.name}</b> <small>${typeBadge}</small></div>
                             <div class="status-badge ${data.isActive?'status-active':'status-closed'}">${data.isActive?'Live':'Closed'}</div>`;
            div.onclick = () => openDetails(docSnap.id, data);
            listDiv.appendChild(div);
        });
    };

    // --- DETAILS & EDIT LOGIC ---
    let currentEventId = null;
    let currentAttendees = [];

    async function openDetails(id, data) {
        currentEventId = id;
        switchTab('details');
        
        // 1. Fill Data
        const nameInput = document.getElementById('edit-name');
        const typeInput = document.getElementById('edit-type');
        const radInput = document.getElementById('edit-radius');
        
        nameInput.value = data.name;
        typeInput.value = data.eventType;
        radInput.value = data.radius;
        document.getElementById('edit-radius-val').innerText = data.radius;

        // 2. Setup Toggle
        const toggle = document.getElementById('toggle-active');
        const newToggle = toggle.cloneNode(true); toggle.parentNode.replaceChild(newToggle, toggle);
        newToggle.checked = data.isActive;
        newToggle.addEventListener('change', async (e) => updateDoc(doc(db, "events", id), { isActive: e.target.checked }));

        // 3. Setup Mini Map (The Screen Grab)
        if(detailsMap) detailsMap.remove(); // Clear old map instance
        detailsMap = L.map('details-map').setView([data.latitude, data.longitude], 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(detailsMap);
        
        detailsMarker = L.marker([data.latitude, data.longitude], {draggable: false}).addTo(detailsMap);
        detailsCircle = L.circle([data.latitude, data.longitude], { color: 'blue', radius: data.radius }).addTo(detailsMap);

        // Sync Marker & Circle in Edit Map
        detailsMarker.on('drag', (e) => detailsCircle.setLatLng(e.target.getLatLng()));

        // 4. Disable Editing Initially
        disableEditing(true);

        // 5. Load Attendees
        loadAttendees(id);
    }

    // --- EDIT BUTTONS ---
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    
    editBtn.onclick = () => {
        disableEditing(false); // Enable inputs
        editBtn.classList.add('hidden');
        saveBtn.classList.remove('hidden');
        detailsMarker.dragging.enable(); // Allow moving pin
    };

    saveBtn.onclick = async () => {
        saveBtn.innerText = "Saving...";
        try {
            const newLat = detailsMarker.getLatLng().lat;
            const newLng = detailsMarker.getLatLng().lng;
            const newRad = parseInt(document.getElementById('edit-radius').value);
            const newName = document.getElementById('edit-name').value;
            const newType = document.getElementById('edit-type').value;

            await updateDoc(doc(db, "events", currentEventId), {
                name: newName,
                eventType: newType,
                latitude: newLat,
                longitude: newLng,
                radius: newRad
            });

            alert("Event Updated!");
            disableEditing(true);
            editBtn.classList.remove('hidden');
            saveBtn.classList.add('hidden');
            saveBtn.innerText = "üíæ Save";
            detailsMarker.dragging.disable();
            
        } catch(e) { alert("Error saving"); }
    };

    function disableEditing(disable) {
        const inputs = ['edit-name', 'edit-type', 'edit-radius'];
        inputs.forEach(id => {
            const el = document.getElementById(id);
            el.disabled = disable;
            if(disable) el.classList.add('disabled-input');
            else el.classList.remove('disabled-input');
        });
    }

    document.getElementById('edit-radius').addEventListener('input', (e) => {
        document.getElementById('edit-radius-val').innerText = e.target.value;
        if(detailsCircle) detailsCircle.setRadius(e.target.value);
    });

    async function loadAttendees(id) {
        const list = document.getElementById('attendee-list');
        list.innerHTML = "Loading...";
        const q = query(collection(db, "attendees"), where("eventId", "==", id));
        const snap = await getDocs(q);
        list.innerHTML = ""; currentAttendees = [];
        document.getElementById('count-val').innerText = snap.size;
        
        snap.forEach(d => {
            const att = d.data(); currentAttendees.push(att);
            const li = document.createElement('li');
            li.innerText = `${att.name} (${att.studentId || 'Ext'}) - ${att.timestamp.toDate().toLocaleTimeString()}`;
            list.appendChild(li);
        });
    }

    window.switchTab = (tabName) => {
        ['create', 'history', 'details'].forEach(t => document.getElementById(`view-${t}`).classList.add('hidden'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`view-${tabName}`).classList.remove('hidden');
        if(tabName === 'create') setTimeout(() => map.invalidateSize(), 200);
        if(tabName === 'details' && detailsMap) setTimeout(() => detailsMap.invalidateSize(), 200);
    }
    
    // ... (Keep existing downloadCSV and deleteCurrentEvent functions) ...
    window.downloadCSV = () => {
        if(!currentAttendees.length) return alert("No data.");
        let csv = "Name,Email,ID,Time\n";
        currentAttendees.forEach(row => csv += `"${row.name}",${row.email},${row.studentId},"${row.timestamp.toDate().toLocaleString()}"\n`);
        const a = document.createElement('a');
        a.href = window.URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
        a.download = `attendance.csv`;
        a.click();
    };

    window.deleteCurrentEvent = async () => {
        if(!currentEventId || !confirm("Delete event?")) return;
        const batch = writeBatch(db);
        batch.delete(doc(db, "events", currentEventId));
        const snaps = await getDocs(query(collection(db, "attendees"), where("eventId", "==", currentEventId)));
        snaps.forEach(s => batch.delete(s.ref));
        await batch.commit();
        alert("Deleted.");
        switchTab('history');
        loadHistory();
    };
</script>
</body>
</html>
