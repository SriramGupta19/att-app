<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
</head>
<body>

<div class="container">
    <h1>Admin Dashboard</h1>
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('create')">Create Event</div>
        <div class="tab" onclick="switchTab('history'); loadHistory()">Event History</div>
    </div>

    <div id="view-create">
        <input type="text" id="eventName" placeholder="Event Name (e.g., Physics 101)">
        <div id="map"></div>
        <label>Radius: <span id="radiusVal">50</span>m</label>
        <input type="range" id="radiusSlider" min="10" max="500" value="50">
        <button id="createBtn">Create Event</button>

        <div id="qr-result" class="hidden" style="text-align:center; margin-top:20px;">
            <canvas id="qr-code"></canvas>
            <p>Event Created! Scan or share this code.</p>
        </div>
    </div>

    <div id="view-history" class="hidden">
        <div id="events-list">Loading events...</div>
    </div>

    <div id="view-details" class="hidden">
        <button class="secondary" onclick="switchTab('history')">‚Üê Back to List</button>
        <h2 id="detail-title">Event Name</h2>
        
        <div style="display:flex; align-items:center; margin-bottom:15px;">
            <span>Accepting Responses: </span>
            <label class="switch">
                <input type="checkbox" id="toggle-active">
                <span class="slider"></span>
            </label>
        </div>

        <button onclick="downloadCSV()">Download Attendee List (CSV)</button>
        
        <h3>Attendees</h3>
        <ul id="attendee-list"></ul>
    </div>
</div>

<script type="module">
    import { db, collection, addDoc, getDocs, query, orderBy, where, doc, updateDoc, Timestamp } from './script.js';

    // --- MAP SETUP (Leaflet) ---
    let map, marker, circle;
    // Initialize map immediately
    map = L.map('map').setView([40.7128, -74.0060], 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    marker = L.marker([40.7128, -74.0060], {draggable: true}).addTo(map);
    circle = L.circle([40.7128, -74.0060], { color: 'red', radius: 50 }).addTo(map);

    marker.on('drag', (e) => circle.setLatLng(e.target.getLatLng()));
    if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(p => {
            const loc = [p.coords.latitude, p.coords.longitude];
            map.setView(loc, 18); marker.setLatLng(loc); circle.setLatLng(loc);
        });
    }

    // Radius Slider
    document.getElementById('radiusSlider').addEventListener('input', (e) => {
        document.getElementById('radiusVal').innerText = e.target.value;
        circle.setRadius(e.target.value);
    });

    // --- CREATE EVENT ---
    document.getElementById('createBtn').addEventListener('click', async () => {
        const name = document.getElementById('eventName').value;
        if(!name) return alert("Enter name");
        
        try {
            const docRef = await addDoc(collection(db, "events"), {
                name: name,
                latitude: marker.getLatLng().lat,
                longitude: marker.getLatLng().lng,
                radius: parseInt(document.getElementById('radiusSlider').value),
                isActive: true,
                createdAt: Timestamp.now()
            });

            // Generate QR
            const url = `${window.location.href.replace('admin.html', 'index.html')}?id=${docRef.id}`;
            new QRious({ element: document.getElementById('qr-code'), value: url, size: 200 });
            document.getElementById('qr-result').classList.remove('hidden');
            alert("Event Created!");
        } catch(e) { console.error(e); alert("Error"); }
    });

    // --- HISTORY & DETAILS ---
    window.loadHistory = async () => {
        const listDiv = document.getElementById('events-list');
        listDiv.innerHTML = "Loading...";
        
        const q = query(collection(db, "events"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        
        listDiv.innerHTML = "";
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const statusClass = data.isActive ? 'status-active' : 'status-closed';
            const statusText = data.isActive ? 'Live' : 'Closed';
            
            const div = document.createElement('div');
            div.className = 'event-card';
            div.innerHTML = `
                <div><strong>${data.name}</strong></div>
                <div class="status-badge ${statusClass}">${statusText}</div>
            `;
            div.onclick = () => openDetails(docSnap.id, data);
            listDiv.appendChild(div);
        });
    };

    let currentEventId = null;
    let currentAttendees = [];

    async function openDetails(id, data) {
        currentEventId = id;
        switchTab('details');
        document.getElementById('detail-title').innerText = data.name;
        
        // Set Toggle State
        const toggle = document.getElementById('toggle-active');
        toggle.checked = data.isActive;
        
        // Add Listener for Toggle Change
        toggle.onclick = async () => {
            await updateDoc(doc(db, "events", id), { isActive: toggle.checked });
            alert(`Event is now ${toggle.checked ? 'OPEN' : 'CLOSED'}`);
        };

        // Load Attendees
        const list = document.getElementById('attendee-list');
        list.innerHTML = "Loading attendees...";
        
        const q = query(collection(db, "attendees"), where("eventId", "==", id));
        const snap = await getDocs(q);
        
        list.innerHTML = "";
        currentAttendees = [];
        
        if (snap.empty) {
            list.innerHTML = "<li>No attendees yet.</li>";
        } else {
            snap.forEach(d => {
                const att = d.data();
                currentAttendees.push(att);
                const li = document.createElement('li');
                // Format timestamp nicely
                const time = att.timestamp ? att.timestamp.toDate().toLocaleTimeString() : 'N/A';
                li.innerText = `${att.name} (${att.studentId || 'No ID'}) - ${time}`;
                list.appendChild(li);
            });
        }
    }

    // --- CSV EXPORT ---
    window.downloadCSV = () => {
        if(currentAttendees.length === 0) return alert("No data to download");
        
        let csv = "Name,Student ID,Time\n";
        currentAttendees.forEach(row => {
            const time = row.timestamp ? row.timestamp.toDate().toLocaleString() : '';
            csv += `${row.name},${row.studentId},"${time}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `attendance_${currentEventId}.csv`;
        a.click();
    }

    // --- UI TABS ---
    window.switchTab = (tabName) => {
        document.getElementById('view-create').classList.add('hidden');
        document.getElementById('view-history').classList.add('hidden');
        document.getElementById('view-details').classList.add('hidden');
        
        // Reset Tabs Style
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

        if(tabName === 'create') {
            document.getElementById('view-create').classList.remove('hidden');
            document.querySelector('.tab:nth-child(1)').classList.add('active');
            setTimeout(() => map.invalidateSize(), 100); // Fix map rendering glitch
        } else if (tabName === 'history') {
            document.getElementById('view-history').classList.remove('hidden');
            document.querySelector('.tab:nth-child(2)').classList.add('active');
        } else if (tabName === 'details') {
            document.getElementById('view-details').classList.remove('hidden');
        }
    }
</script>
</body>
</html>
