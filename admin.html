<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    
    <link rel="stylesheet" href="style.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>

<div class="container">
    <h1>Admin Dashboard</h1>
    
    <div class="tabs">
        <div id="tab-create" class="tab active" onclick="switchTab('create')">Create Event</div>
        <div id="tab-history" class="tab" onclick="switchTab('history'); loadHistory()">Event History</div>
    </div>

    <div id="view-create">
        <p style="color:#666; margin-bottom:10px;">1. Enter Name &rarr; 2. Set Location &rarr; 3. Create</p>
        
        <input type="text" id="eventName" placeholder="Event Name (e.g., Physics 101)">
        
        <div id="map"></div>
        
        <div class="flex-row">
            <label>Geofence Radius: <strong id="radiusVal">50</strong> m</label>
        </div>
        <input type="range" id="radiusSlider" min="10" max="500" value="50">
        
        <button id="createBtn">Create Event & Generate QR</button>

        <div id="qr-result" class="hidden" style="text-align:center; margin-top:20px; background:#f9f9f9; padding:20px; border:2px dashed #ddd; border-radius:10px;">
            <h3 style="margin-top:0; color:#27ae60;">✅ Event Created!</h3>
            
            <img id="qr-image" src="" alt="Generating QR..." style="width: 200px; height: 200px; border: 1px solid #ccc; padding: 5px; background: white;">
            
            <p style="margin-bottom:5px; margin-top:15px; font-weight:bold;">Scan or Share:</p>
            <a id="share-link" href="#" target="_blank" style="word-break: break-all; color:#3498db; text-decoration:underline;">Link</a>
        </div>
    </div>

    <div id="view-history" class="hidden">
        <h3>Past Events</h3>
        <div id="events-list"><p>Loading...</p></div>
    </div>

    <div id="view-details" class="hidden">
        <div class="flex-row">
            <button class="secondary" style="width: auto;" onclick="switchTab('history')">← Back</button>
            <div style="display:flex; align-items:center;">
                <span style="font-size:0.9em; margin-right:5px;">Accepting Responses:</span>
                <label class="switch">
                    <input type="checkbox" id="toggle-active">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        <h2 id="detail-title">Event Name</h2>
        <p>Total Attendees: <strong id="count-val">0</strong></p>
        <button onclick="downloadCSV()">Download CSV</button>
        <ul id="attendee-list"><li>Loading...</li></ul>
        <button class="danger" onclick="deleteCurrentEvent()">Delete Event</button>
    </div>
</div>

<script type="module">
    import { db, collection, addDoc, getDocs, query, orderBy, where, doc, updateDoc, deleteDoc, writeBatch, Timestamp } from './script.js';

    let map, marker, circle;

    // --- MAP INITIALIZATION ---
    function initMap() {
        let startLoc = [40.7128, -74.0060]; 
        map = L.map('map').setView(startLoc, 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
        marker = L.marker(startLoc, {draggable: true}).addTo(map);
        circle = L.circle(startLoc, { color: 'red', radius: 50 }).addTo(map);
        marker.on('drag', (e) => circle.setLatLng(e.target.getLatLng()));

        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => {
                const loc = [p.coords.latitude, p.coords.longitude];
                map.setView(loc, 18); marker.setLatLng(loc); circle.setLatLng(loc);
            });
        }
    }
    initMap();

    // Slider UI Update
    document.getElementById('radiusSlider').addEventListener('input', (e) => {
        document.getElementById('radiusVal').innerText = e.target.value;
        circle.setRadius(e.target.value);
    });

    // --- MAIN CREATE FUNCTION ---
    document.getElementById('createBtn').addEventListener('click', async () => {
        const nameInput = document.getElementById('eventName');
        const name = nameInput.value;
        const btn = document.getElementById('createBtn');
        const qrContainer = document.getElementById('qr-result');
        const qrImage = document.getElementById('qr-image');
        const shareLink = document.getElementById('share-link');

        if(!name) return alert("Please enter an event name.");
        
        btn.innerText = "Creating...";
        btn.disabled = true;

        try {
            // 1. Save to Firebase
            const docRef = await addDoc(collection(db, "events"), {
                name: name,
                latitude: marker.getLatLng().lat,
                longitude: marker.getLatLng().lng,
                radius: parseInt(document.getElementById('radiusSlider').value),
                isActive: true,
                createdAt: Timestamp.now()
            });

            console.log("Created Event ID:", docRef.id);

            // 2. Construct the Attendance URL
            const baseUrl = window.location.href.replace('admin.html', 'index.html');
            const finalUrl = `${baseUrl}?id=${docRef.id}`;
            console.log("Final URL:", finalUrl);

            // 3. Generate QR (Using robust API method)
            // This URL returns a PNG image of the QR code
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(finalUrl)}`;
            
            // 4. Update UI
            qrImage.src = qrApiUrl; // Set image source
            shareLink.href = finalUrl;
            shareLink.innerText = finalUrl;
            
            // Show the result container
            qrContainer.classList.remove('hidden');
            
            // Reset Button
            btn.innerText = "Create Another Event";
            btn.disabled = false;
            nameInput.value = ""; 

        } catch(e) {
            console.error("Error creating event:", e);
            alert("Error: " + e.message);
            btn.innerText = "Create Event";
            btn.disabled = false;
        }
    });

    // --- TAB SWITCHER ---
    window.switchTab = (tabName) => {
        ['create', 'history', 'details'].forEach(t => document.getElementById(`view-${t}`).classList.add('hidden'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

        if(tabName === 'create') {
            document.getElementById('view-create').classList.remove('hidden');
            document.getElementById('tab-create').classList.add('active');
            setTimeout(() => map.invalidateSize(), 200);
        } else if (tabName === 'history') {
            document.getElementById('view-history').classList.remove('hidden');
            document.getElementById('tab-history').classList.add('active');
        } else if (tabName === 'details') {
            document.getElementById('view-details').classList.remove('hidden');
        }
    }

    // --- HISTORY LOGIC ---
    window.loadHistory = async () => {
        const listDiv = document.getElementById('events-list');
        listDiv.innerHTML = "Loading...";
        const q = query(collection(db, "events"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        
        listDiv.innerHTML = "";
        if(snapshot.empty) listDiv.innerHTML = "No events found.";

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const div = document.createElement('div');
            div.className = 'event-card';
            div.innerHTML = `<div><b>${data.name}</b><br><small>${data.createdAt.toDate().toLocaleDateString()}</small></div>
                             <div class="status-badge ${data.isActive?'status-active':'status-closed'}">${data.isActive?'Live':'Closed'}</div>`;
            div.onclick = () => openDetails(docSnap.id, data);
            listDiv.appendChild(div);
        });
    };

    // --- DETAILS LOGIC ---
    let currentEventId = null;
    let currentAttendees = [];

    async function openDetails(id, data) {
        currentEventId = id;
        switchTab('details');
        document.getElementById('detail-title').innerText = data.name;
        
        // Setup Toggle
        const toggle = document.getElementById('toggle-active');
        const newToggle = toggle.cloneNode(true); // Remove old listeners
        toggle.parentNode.replaceChild(newToggle, toggle);
        newToggle.checked = data.isActive;
        newToggle.addEventListener('change', async (e) => {
            await updateDoc(doc(db, "events", id), { isActive: e.target.checked });
        });

        // Load Attendees
        const list = document.getElementById('attendee-list');
        list.innerHTML = "Loading...";
        const q = query(collection(db, "attendees"), where("eventId", "==", id));
        const snap = await getDocs(q);
        
        list.innerHTML = "";
        currentAttendees = [];
        document.getElementById('count-val').innerText = snap.size;

        if(snap.empty) list.innerHTML = "<li>No attendees.</li>";
        else snap.forEach(d => {
            const att = d.data();
            currentAttendees.push(att);
            const li = document.createElement('li');
            li.innerText = `${att.name} (${att.studentId}) - ${att.timestamp.toDate().toLocaleTimeString()}`;
            list.appendChild(li);
        });
    }

    window.downloadCSV = () => {
        if(!currentAttendees.length) return alert("No data.");
        let csv = "Name,Email,ID,Time\n";
        currentAttendees.forEach(row => csv += `"${row.name}",${row.email},${row.studentId},"${row.timestamp.toDate().toLocaleString()}"\n`);
        const a = document.createElement('a');
        a.href = window.URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
        a.download = `attendance.csv`;
        a.click();
    };

    window.deleteCurrentEvent = async () => {
        if(!currentEventId || !confirm("Permanently delete this event?")) return;
        const batch = writeBatch(db);
        batch.delete(doc(db, "events", currentEventId));
        const snaps = await getDocs(query(collection(db, "attendees"), where("eventId", "==", currentEventId)));
        snaps.forEach(s => batch.delete(s.ref));
        await batch.commit();
        alert("Deleted.");
        switchTab('history');
        loadHistory();
    };
</script>
</body>
</html>
