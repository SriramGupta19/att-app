<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        .login-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
        .google-btn { background-color: #4285F4; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; margin-top: 20px; font-weight: bold; }
        .hidden { display: none !important; }
        .alt-box { background: #eef2ff; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #c7d2fe; }
        .alt-val { font-family: monospace; font-weight: bold; color: #4338ca; }
        select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; }
    </style>
</head>
<body>

<div class="container">

    <div id="view-login" class="login-wrapper">
        <h1>Admin Portal</h1>
        <p>Restricted Access</p>
        <button id="loginBtn" class="google-btn">Sign in with Google</button>
        <p id="auth-error" style="color:red; margin-top:15px; font-weight:bold;"></p>
    </div>

    <div id="view-dashboard" class="hidden">
        <div class="flex-row" style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:20px;">
            <h1 style="margin:0;">Admin Dashboard</h1>
            <button class="secondary" id="logoutBtn" style="width:auto; padding:5px 15px; font-size:0.8em;">Logout</button>
        </div>
        
        <div class="tabs">
            <div id="tab-create" class="tab active" onclick="switchTab('create')">Create Event</div>
            <div id="tab-history" class="tab" onclick="switchTab('history'); loadHistory()">Event History</div>
        </div>

        <div id="view-create">
            <input type="text" id="eventName" placeholder="Event Name (e.g., Physics 101)">
            
            <label style="display:block; margin-top:10px; color:#666; font-weight:bold;">Event Type:</label>
            <select id="eventType">
                <option value="internal">Internal (NITC Email Only)</option>
                <option value="external">External (Open to All)</option>
            </select>

            <div id="map"></div>
            
            <div class="flex-row">
                <label>Geofence Radius: <strong id="radiusVal">50</strong> m</label>
            </div>
            <input type="range" id="radiusSlider" min="10" max="500" value="50">
            
            <div class="alt-box">
                <div class="flex-row">
                    <label>‚ö†Ô∏è Floor/Elevation Lock</label>
                    <label class="switch"><input type="checkbox" id="useAltitude"><span class="slider"></span></label>
                </div>
                <p style="font-size:0.85em; color:#666; margin-top:0;">Only enable if you are currently AT the venue floor.</p>
                
                <div id="alt-controls" class="hidden">
                    <p>Captured Altitude: <span id="captured-alt" class="alt-val">Not Set</span></p>
                    <p>Buffer: +/- <span id="v-buffer-val">1</span> meters</p>
                    <input type="range" id="vBufferSlider" min="5" max="30" value="10">
                    <button id="captureAltBtn" class="secondary" style="margin-top:5px;">üìç Capture My Elevation</button>
                </div>
            </div>

            <button id="createBtn" style="margin-top: 20px;">Create Event & Generate QR</button>

            <div id="qr-result" class="hidden" style="text-align:center; margin-top:20px; background:#f9f9f9; padding:20px; border:2px dashed #ddd; border-radius:10px;">
                <h3 style="margin-top:0; color:#27ae60;">‚úÖ Event Created!</h3>
                <img id="qr-image" src="" alt="Generating QR..." style="width: 200px; height: 200px; border: 1px solid #ccc; padding: 5px; background: white;">
                <p style="margin-bottom:5px; margin-top:15px; font-weight:bold;">Share Link:</p>
                <a id="share-link" href="#" target="_blank" style="word-break: break-all; color:#3498db; text-decoration:underline;">Link</a>
            </div>
        </div>

        <div id="view-history" class="hidden">
            <h3>Past Events</h3>
            <div id="events-list"><p>Loading...</p></div>
        </div>

        <div id="view-details" class="hidden">
            <div class="flex-row">
                <button class="secondary" style="width: auto;" onclick="switchTab('history')">‚Üê Back</button>
                <div style="display:flex; align-items:center;">
                    <span style="font-size:0.9em; margin-right:5px;">Accepting Responses:</span>
                    <label class="switch"><input type="checkbox" id="toggle-active"><span class="slider"></span></label>
                </div>
            </div>
            <h2 id="detail-title">Event Name</h2>
            <p>Type: <strong id="detail-type">...</strong></p>
            <p>Total Attendees: <strong id="count-val">0</strong></p>
            <button onclick="downloadCSV()">Download CSV</button>
            <ul id="attendee-list" style="max-height:200px; overflow-y:auto; background:#fafafa; border:1px solid #eee; padding:10px;"><li>Loading...</li></ul>
            <button class="danger" onclick="deleteCurrentEvent()">Delete Event</button>
        </div>
    </div>
</div>

<script type="module">
    import { db, auth, collection, addDoc, getDocs, query, orderBy, where, doc, updateDoc, deleteDoc, writeBatch, Timestamp, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from './script.js';

    // --- CONFIGURATION ---
    const ALLOWED_ADMIN = "maddula_m241070ee@nitc.ac.in";
    let map, marker, circle, capturedAltitude = null;

    // --- AUTHENTICATION ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            if (user.email === ALLOWED_ADMIN) {
                document.getElementById('view-login').classList.add('hidden');
                document.getElementById('view-dashboard').classList.remove('hidden');
                setTimeout(initMap, 500); 
            } else {
                alert("Access Denied: You are not the authorized admin.");
                signOut(auth);
            }
        } else {
            document.getElementById('view-login').classList.remove('hidden');
            document.getElementById('view-dashboard').classList.add('hidden');
        }
    });

    document.getElementById('loginBtn').addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));
    document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth).then(() => window.location.reload()));

    // --- MAP LOGIC ---
    function initMap() {
        if(map) return;
        let startLoc = [11.3216, 75.9336]; // Default to NIT Calicut approx loc
        map = L.map('map').setView(startLoc, 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        marker = L.marker(startLoc, {draggable: true}).addTo(map);
        circle = L.circle(startLoc, { color: 'red', radius: 50 }).addTo(map);
        marker.on('drag', (e) => circle.setLatLng(e.target.getLatLng()));

        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => {
                const loc = [p.coords.latitude, p.coords.longitude];
                map.setView(loc, 18); marker.setLatLng(loc); circle.setLatLng(loc);
            });
        }
    }

    document.getElementById('radiusSlider').addEventListener('input', (e) => {
        document.getElementById('radiusVal').innerText = e.target.value;
        circle.setRadius(e.target.value);
    });

    // --- ALTITUDE LOGIC ---
    document.getElementById('useAltitude').addEventListener('change', (e) => {
        const controls = document.getElementById('alt-controls');
        if(e.target.checked) controls.classList.remove('hidden');
        else { controls.classList.add('hidden'); capturedAltitude = null; }
    });

    document.getElementById('captureAltBtn').addEventListener('click', () => {
        document.getElementById('captureAltBtn').innerText = "Reading Sensors...";
        navigator.geolocation.getCurrentPosition(pos => {
            if (pos.coords.altitude === null) {
                alert("Your device hardware cannot detect altitude.");
                return;
            }
            capturedAltitude = pos.coords.altitude;
            document.getElementById('captured-alt').innerText = `${Math.round(capturedAltitude)}m`;
            document.getElementById('captureAltBtn').innerText = "‚úÖ Captured";
        }, err => alert("GPS Error"), { enableHighAccuracy: true });
    });

    // --- CREATE EVENT ---
    document.getElementById('createBtn').addEventListener('click', async () => {
        const name = document.getElementById('eventName').value;
        const type = document.getElementById('eventType').value;
        const useAlt = document.getElementById('useAltitude').checked;
        const btn = document.getElementById('createBtn');

        if(!name) return alert("Enter Event Name");
        if(useAlt && capturedAltitude === null) return alert("Please capture altitude or disable the lock.");

        btn.innerText = "Creating..."; btn.disabled = true;

        try {
            const docRef = await addDoc(collection(db, "events"), {
                name: name,
                eventType: type,
                latitude: marker.getLatLng().lat,
                longitude: marker.getLatLng().lng,
                radius: parseInt(document.getElementById('radiusSlider').value),
                checkAltitude: useAlt,
                targetAltitude: capturedAltitude,
                altitudeBuffer: parseInt(document.getElementById('vBufferSlider').value),
                isActive: true,
                createdAt: Timestamp.now()
            });

            // QR Generation
            const baseUrl = window.location.href.replace('admin.html', 'index.html');
            const finalUrl = `${baseUrl}?id=${docRef.id}`;
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(finalUrl)}`;
            
            document.getElementById('qr-image').src = qrApiUrl;
            document.getElementById('share-link').href = finalUrl;
            document.getElementById('share-link').innerText = finalUrl;
            document.getElementById('qr-result').classList.remove('hidden');
            
            btn.innerText = "Create Another"; btn.disabled = false;
        } catch(e) { console.error(e); alert("Error"); btn.disabled = false; }
    });

    // --- TABS & HISTORY ---
    window.switchTab = (tabName) => {
        ['create', 'history', 'details'].forEach(t => document.getElementById(`view-${t}`).classList.add('hidden'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`view-${tabName}`).classList.remove('hidden');
        if(tabName === 'create') setTimeout(() => map.invalidateSize(), 200);
    }

    window.loadHistory = async () => {
        const listDiv = document.getElementById('events-list');
        listDiv.innerHTML = "Loading...";
        const q = query(collection(db, "events"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        listDiv.innerHTML = "";
        if(snapshot.empty) { listDiv.innerHTML = "No events."; return; }

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const badge = data.eventType === 'internal' 
                ? '<span style="background:#e0f2fe; color:#0369a1; padding:2px 5px; border-radius:4px; font-size:0.7em;">Internal</span>' 
                : '<span style="background:#f3e8ff; color:#7e22ce; padding:2px 5px; border-radius:4px; font-size:0.7em;">External</span>';
            
            const div = document.createElement('div');
            div.className = 'event-card';
            div.innerHTML = `<div><b>${data.name}</b> ${badge}<br><small>${data.createdAt.toDate().toLocaleDateString()}</small></div>
                             <div class="status-badge ${data.isActive?'status-active':'status-closed'}">${data.isActive?'Live':'Closed'}</div>`;
            div.onclick = () => openDetails(docSnap.id, data);
            listDiv.appendChild(div);
        });
    };

    let currentEventId = null; let currentAttendees = [];
    async function openDetails(id, data) {
        currentEventId = id; switchTab('details');
        document.getElementById('detail-title').innerText = data.name;
        document.getElementById('detail-type').innerText = data.eventType;
        
        const toggle = document.getElementById('toggle-active');
        const newToggle = toggle.cloneNode(true); toggle.parentNode.replaceChild(newToggle, toggle);
        newToggle.checked = data.isActive;
        newToggle.addEventListener('change', async (e) => updateDoc(doc(db, "events", id), { isActive: e.target.checked }));

        const list = document.getElementById('attendee-list'); list.innerHTML = "Loading...";
        const q = query(collection(db, "attendees"), where("eventId", "==", id));
        const snap = await getDocs(q);
        list.innerHTML = ""; currentAttendees = [];
        document.getElementById('count-val').innerText = snap.size;
        
        snap.forEach(d => {
            const att = d.data(); currentAttendees.push(att);
            const li = document.createElement('li');
            li.innerText = `${att.name} (${att.studentId}) - ${att.timestamp.toDate().toLocaleTimeString()}`;
            list.appendChild(li);
        });
    }

    window.downloadCSV = () => {
        if(!currentAttendees.length) return alert("No data");
        let csv = "Name,Email,ID,Time\n";
        currentAttendees.forEach(row => csv += `"${row.name}",${row.email},${row.studentId},"${row.timestamp.toDate().toLocaleString()}"\n`);
        const a = document.createElement('a'); a.href = window.URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
        a.download = "attendance.csv"; a.click();
    };

    window.deleteCurrentEvent = async () => {
        if(!confirm("Delete event?")) return;
        const batch = writeBatch(db);
        batch.delete(doc(db, "events", currentEventId));
        const snaps = await getDocs(query(collection(db, "attendees"), where("eventId", "==", currentEventId)));
        snaps.forEach(s => batch.delete(s.ref));
        await batch.commit();
        alert("Deleted"); switchTab('history'); loadHistory();
    };
</script>
</body>
</html>
