<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Create Event</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_KEY_HERE&callback=initMap" async defer></script>
</head>
<body>

<div class="container">
    <h1>Create Attendance Event</h1>
    
    <input type="text" id="eventName" placeholder="Event Name (e.g., Math 101)">
    <div id="map"></div>
    
    <label>Allowed Radius: <span id="radiusVal">50</span> meters</label>
    <input type="range" id="radiusSlider" min="10" max="500" value="50">

    <button id="createBtn">Create Event & Generate QR</button>

    <div id="qr-section" style="display:none; text-align:center;">
        <h3>Scan to Attend:</h3>
        <canvas id="qr-code"></canvas>
        <p>Students must be within the red circle.</p>
        <p><strong>Link:</strong> <a id="eventLink" href="#" target="_blank">Open Link</a></p>
    </div>
</div>

<script type="module">
    import { db, collection, addDoc, Timestamp } from './script.js';

    let map, marker, circle;
    // Default: New York (Just a placeholder startup location)
    let currentLat = 40.7128;
    let currentLng = -74.0060; 

    // Initialize Map (Global function required by Google Maps API)
    window.initMap = function() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: currentLat, lng: currentLng },
            zoom: 18,
        });

        // Draggable Marker
        marker = new google.maps.Marker({
            position: { lat: currentLat, lng: currentLng },
            map: map,
            draggable: true,
            title: "Venue Center"
        });

        // Radius Circle
        circle = new google.maps.Circle({
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#FF0000",
            fillOpacity: 0.35,
            map: map,
            center: { lat: currentLat, lng: currentLng },
            radius: 50
        });

        // Update circle when marker moves
        marker.addListener("drag", () => {
            circle.setCenter(marker.getPosition());
        });

        // Try to get Admin's current location to center map initially
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                const userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                map.setCenter(userPos);
                marker.setPosition(userPos);
                circle.setCenter(userPos);
            });
        }
    }

    // Slider Logic
    const slider = document.getElementById("radiusSlider");
    slider.addEventListener("input", () => {
        const rad = parseInt(slider.value);
        document.getElementById("radiusVal").innerText = rad;
        if(circle) circle.setRadius(rad);
    });

    // Save Event Logic
    document.getElementById("createBtn").addEventListener("click", async () => {
        const name = document.getElementById("eventName").value;
        if(!name) return alert("Please enter an event name");

        const lat = marker.getPosition().lat();
        const lng = marker.getPosition().lng();
        const radius = parseInt(slider.value);

        try {
            // 1. Save to Firebase
            const docRef = await addDoc(collection(db, "events"), {
                name: name,
                latitude: lat,
                longitude: lng,
                radius: radius,
                isActive: true,
                createdAt: Timestamp.now()
            });

            // 2. Generate Link
            // Current URL without 'admin.html', pointing to index.html with param
            const baseUrl = window.location.href.replace('admin.html', 'index.html');
            const attendanceUrl = `${baseUrl}?eventId=${docRef.id}`;

            // 3. Render QR
            const qr = new QRious({
                element: document.getElementById('qr-code'),
                value: attendanceUrl,
                size: 200
            });

            // 4. Show Result
            document.getElementById("qr-section").style.display = "block";
            const linkTag = document.getElementById("eventLink");
            linkTag.href = attendanceUrl;
            linkTag.innerText = attendanceUrl;
            
            alert("Event Created Successfully!");

        } catch (e) {
            console.error("Error adding document: ", e);
            alert("Error creating event. Check console.");
        }
    });
</script>
</body>
</html>
