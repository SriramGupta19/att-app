<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    
    <link rel="stylesheet" href="style.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
</head>
<body>

<div class="container">
    <h1>Admin Dashboard</h1>
    
    <div class="tabs">
        <div id="tab-create" class="tab active" onclick="switchTab('create')">Create Event</div>
        <div id="tab-history" class="tab" onclick="switchTab('history'); loadHistory()">Event History</div>
    </div>

    <div id="view-create">
        <p style="color:#666; margin-bottom:10px;">Drag the pin to set the venue location.</p>
        
        <input type="text" id="eventName" placeholder="Event Name (e.g., Physics 101)">
        
        <div id="map"></div>
        
        <div class="flex-row">
            <label>Geofence Radius: <strong id="radiusVal">50</strong> m</label>
        </div>
        <input type="range" id="radiusSlider" min="10" max="500" value="50">
        
        <button id="createBtn">Create Event & Generate QR</button>

        <div id="qr-result" style="display: none; margin-top: 20px; text-align: center; border: 2px dashed #ddd; padding: 20px; background: #f9f9f9; border-radius: 10px;">
            <h3 style="margin-top:0; color:#27ae60;">✅ Event Created!</h3>
            <canvas id="qr-code"></canvas>
            <p style="margin-bottom:5px;">Share this link with students:</p>
            <a id="share-link" href="#" target="_blank" style="word-break: break-all; font-weight:bold;">Link</a>
        </div>
    </div>

    <div id="view-history" class="hidden">
        <h3>Past Events</h3>
        <div id="events-list">
            <p style="color:#888;">Loading events...</p>
        </div>
    </div>

    <div id="view-details" class="hidden">
        <div class="flex-row">
            <button class="secondary" style="width: auto;" onclick="switchTab('history')">← Back to History</button>
            
            <div style="display:flex; align-items:center;">
                <span style="font-size:0.9em; margin-right:5px;">Accepting Responses:</span>
                <label class="switch">
                    <input type="checkbox" id="toggle-active">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
        
        <h2 id="detail-title" style="margin-bottom: 5px;">Event Name</h2>
        <p style="color:#666; font-size:0.9em; margin-top:0;">Total Attendees: <strong id="count-val">0</strong></p>

        <button onclick="downloadCSV()" style="margin-bottom: 20px;">Download Attendee List (CSV)</button>
        
        <div style="background: #fafafa; border: 1px solid #eee; padding: 10px; border-radius: 8px;">
            <h4 style="margin-top:0;">Attendees Log:</h4>
            <ul id="attendee-list" style="padding-left: 20px; max-height: 200px; overflow-y: auto;">
                <li>Loading...</li>
            </ul>
        </div>

        <button class="danger" onclick="deleteCurrentEvent()">Delete This Event</button>
    </div>

</div>

<script type="module">
    // Import functions from script.js
    import { db, collection, addDoc, getDocs, query, orderBy, where, doc, updateDoc, deleteDoc, writeBatch, Timestamp } from './script.js';

    // --- MAP VARIABLES ---
    let map, marker, circle;

    // --- INITIALIZE MAP ---
    function initMap() {
        // Default Location: Starts at (0,0) then updates to user location
        let startLoc = [40.7128, -74.0060]; 

        map = L.map('map').setView(startLoc, 18);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
            attribution: '© OpenStreetMap' 
        }).addTo(map);

        marker = L.marker(startLoc, {draggable: true}).addTo(map);
        circle = L.circle(startLoc, { color: 'red', fillColor: '#f03', fillOpacity: 0.2, radius: 50 }).addTo(map);

        // Update Circle when Marker is dragged
        marker.on('drag', (e) => {
            circle.setLatLng(e.target.getLatLng());
        });

        // Try to get Admin's real location
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => {
                const loc = [p.coords.latitude, p.coords.longitude];
                map.setView(loc, 18); 
                marker.setLatLng(loc); 
                circle.setLatLng(loc);
            });
        }
    }

    // Initialize Map on Load
    initMap();

    // --- SLIDER LOGIC ---
    const slider = document.getElementById('radiusSlider');
    slider.addEventListener('input', (e) => {
        const val = e.target.value;
        document.getElementById('radiusVal').innerText = val;
        circle.setRadius(val);
    });

    // --- TAB SWITCHING LOGIC ---
    window.switchTab = (tabName) => {
        // 1. Hide all sections
        document.getElementById('view-create').classList.add('hidden');
        document.getElementById('view-history').classList.add('hidden');
        document.getElementById('view-details').classList.add('hidden');
        
        // 2. Remove active class from tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

        // 3. Show selected section
        if(tabName === 'create') {
            document.getElementById('view-create').classList.remove('hidden');
            document.getElementById('tab-create').classList.add('active');
            setTimeout(() => map.invalidateSize(), 200); // Refreshes map to prevent grey box
        } 
        else if (tabName === 'history') {
            document.getElementById('view-history').classList.remove('hidden');
            document.getElementById('tab-history').classList.add('active');
        } 
        else if (tabName === 'details') {
            document.getElementById('view-details').classList.remove('hidden');
        }
    }

    // --- FEATURE 1: CREATE EVENT ---
    document.getElementById('createBtn').addEventListener('click', async () => {
        const nameInput = document.getElementById('eventName');
        const name = nameInput.value;
        const btn = document.getElementById('createBtn');

        if(!name) return alert("Please enter an event name first.");
        
        btn.innerText = "Creating...";
        btn.disabled = true;

        try {
            // 1. Save to Firebase
            const docRef = await addDoc(collection(db, "events"), {
                name: name,
                latitude: marker.getLatLng().lat,
                longitude: marker.getLatLng().lng,
                radius: parseInt(slider.value),
                isActive: true, // Default to true
                createdAt: Timestamp.now()
            });

            // 2. Generate QR Code
            const baseUrl = window.location.href.replace('admin.html', 'index.html');
            const finalUrl = `${baseUrl}?id=${docRef.id}`;
            
            const qr = new QRious({
                element: document.getElementById('qr-code'),
                value: finalUrl,
                size: 200
            });

            // 3. Update UI
            document.getElementById('share-link').href = finalUrl;
            document.getElementById('share-link').innerText = finalUrl;
            document.getElementById('qr-result').style.display = 'block'; // Show result
            
            btn.innerText = "Create Another Event";
            btn.disabled = false;
            nameInput.value = ""; // Clear input

        } catch(e) {
            console.error("Error:", e);
            alert("Error creating event. Check console.");
            btn.innerText = "Create Event";
            btn.disabled = false;
        }
    });

    // --- FEATURE 2: LOAD HISTORY ---
    window.loadHistory = async () => {
        const listDiv = document.getElementById('events-list');
        listDiv.innerHTML = "<p>Loading...</p>";
        
        const q = query(collection(db, "events"), orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        
        listDiv.innerHTML = "";
        
        if(snapshot.empty) {
            listDiv.innerHTML = "<p>No past events found.</p>";
            return;
        }

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const statusClass = data.isActive ? 'status-active' : 'status-closed';
            const statusText = data.isActive ? 'Live' : 'Closed';
            
            // Create Card HTML
            const div = document.createElement('div');
            div.className = 'event-card';
            div.innerHTML = `
                <div>
                    <div style="font-weight:bold; font-size:1.1em;">${data.name}</div>
                    <div style="font-size:0.85em; color:#999;">${data.createdAt.toDate().toLocaleDateString()}</div>
                </div>
                <div class="status-badge ${statusClass}">${statusText}</div>
            `;
            // Add Click Event
            div.onclick = () => openDetails(docSnap.id, data);
            listDiv.appendChild(div);
        });
    };

    // --- FEATURE 3: EVENT DETAILS ---
    let currentEventId = null;
    let currentAttendees = [];

    async function openDetails(id, data) {
        currentEventId = id;
        switchTab('details'); // Switch view
        
        document.getElementById('detail-title').innerText = data.name;

        // Setup Toggle Switch
        const toggle = document.getElementById('toggle-active');
        toggle.checked = data.isActive; // Set initial state
        
        // Remove old listener to avoid duplicates
        const newToggle = toggle.cloneNode(true);
        toggle.parentNode.replaceChild(newToggle, toggle);
        
        // Add new listener
        newToggle.addEventListener('change', async (e) => {
            const newState = e.target.checked;
            await updateDoc(doc(db, "events", id), { isActive: newState });
            // alert(`Event is now ${newState ? 'OPEN' : 'CLOSED'}`);
        });

        // Load Attendees List
        loadAttendees(id);
    }

    async function loadAttendees(id) {
        const list = document.getElementById('attendee-list');
        list.innerHTML = "<li>Loading...</li>";
        
        const q = query(collection(db, "attendees"), where("eventId", "==", id));
        const snap = await getDocs(q);
        
        list.innerHTML = "";
        currentAttendees = [];
        document.getElementById('count-val').innerText = snap.size;

        if (snap.empty) {
            list.innerHTML = "<li style='color:#999; list-style:none;'>No attendees yet.</li>";
        } else {
            snap.forEach(d => {
                const att = d.data();
                currentAttendees.push(att);
                const li = document.createElement('li');
                // Check if studentId exists
                const idTxt = att.studentId ? `(ID: ${att.studentId})` : '';
                li.innerText = `${att.name} ${idTxt} - ${att.timestamp.toDate().toLocaleTimeString()}`;
                list.appendChild(li);
            });
        }
    }

    // --- FEATURE 4: CSV DOWNLOAD ---
    window.downloadCSV = () => {
        if(currentAttendees.length === 0) return alert("No data to download.");
        
        let csv = "Name,Student ID,Time\n";
        currentAttendees.forEach(row => {
            const time = row.timestamp.toDate().toLocaleString();
            // Handle commas in names by wrapping in quotes
            csv += `"${row.name}",${row.studentId},"${time}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `attendance_${currentEventId}.csv`;
        a.click();
    };

    // --- FEATURE 5: DELETE EVENT ---
    window.deleteCurrentEvent = async () => {
        if(!currentEventId) return;

        if(confirm("Are you sure? This will delete the event and all attendee data permanently.")) {
            try {
                const batch = writeBatch(db);
                
                // 1. Delete Event
                const eventRef = doc(db, "events", currentEventId);
                batch.delete(eventRef);

                // 2. Delete Attendees
                const q = query(collection(db, "attendees"), where("eventId", "==", currentEventId));
                const snaps = await getDocs(q);
                snaps.forEach(s => batch.delete(s.ref));

                await batch.commit();
                
                alert("Deleted successfully.");
                switchTab('history');
                loadHistory(); // Refresh list

            } catch(e) {
                console.error(e);
                alert("Error deleting.");
            }
        }
    };
</script>
</body>
</html>
