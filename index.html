<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark Attendance</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <div id="view-list">
        <h1>Live Events</h1>
        <p>Select an event to mark your attendance.</p>
        <div id="live-events-list">Loading...</div>
    </div>

    <div id="view-attendance" class="hidden">
        <button class="secondary" onclick="location.reload()">← Back</button>
        <h2 id="event-title">Verifying Location...</h2>
        <div id="status-box" style="padding:15px; background:#eee; text-align:center; margin-bottom:15px;">Initializing...</div>

        <div id="form-container" class="hidden">
            <input type="text" id="studentName" placeholder="Your Name">
            <input type="text" id="studentID" placeholder="ID Number">
            <button id="submitBtn">Submit</button>
        </div>
    </div>
</div>

<script type="module">
    import { db, collection, getDocs, query, where, addDoc, doc, getDoc, Timestamp, getDistanceFromLatLonInMeters } from './script.js';

    // Check if URL has a specific ID (QR Code Scan)
    const urlParams = new URLSearchParams(window.location.search);
    const urlEventId = urlParams.get('id');

    if (urlEventId) {
        startAttendanceFlow(urlEventId);
    } else {
        loadLiveEvents();
    }

    async function loadLiveEvents() {
        const listDiv = document.getElementById('live-events-list');
        // Only get events where isActive == true
        const q = query(collection(db, "events"), where("isActive", "==", true));
        const snapshot = await getDocs(q);

        listDiv.innerHTML = "";
        if(snapshot.empty) {
            listDiv.innerHTML = "<p>No live events found.</p>";
            return;
        }

        snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement('div');
            div.className = 'event-card';
            div.innerHTML = `<strong>${data.name}</strong> <span class="status-badge status-active">Live</span>`;
            div.onclick = () => startAttendanceFlow(doc.id);
            listDiv.appendChild(div);
        });
    }

    async function startAttendanceFlow(eventId) {
        document.getElementById('view-list').classList.add('hidden');
        document.getElementById('view-attendance').classList.remove('hidden');
        
        const statusBox = document.getElementById('status-box');
        
        // 1. Fetch Event Data
        const eventRef = doc(db, "events", eventId);
        const eventSnap = await getDoc(eventRef);
        
        if (!eventSnap.exists()) return statusBox.innerText = "Event not found.";
        const eventData = eventSnap.data();
        document.getElementById('event-title').innerText = eventData.name;

        if (!eventData.isActive) {
            statusBox.innerText = "This event has been closed by the admin.";
            statusBox.classList.add('status-closed');
            return;
        }

        // 2. Geolocation Check
        statusBox.innerText = "Checking GPS...";
        if(!navigator.geolocation) return statusBox.innerText = "GPS not supported.";

        navigator.geolocation.getCurrentPosition(pos => {
            const dist = getDistanceFromLatLonInMeters(
                pos.coords.latitude, pos.coords.longitude,
                eventData.latitude, eventData.longitude
            );
            
            if (dist <= eventData.radius) {
                statusBox.innerText = "✅ You are at the venue.";
                statusBox.classList.add('status-active');
                document.getElementById('form-container').classList.remove('hidden');
                
                // Submit Handler
                document.getElementById('submitBtn').onclick = async () => {
                    const name = document.getElementById('studentName').value;
                    const sid = document.getElementById('studentID').value;
                    if(!name) return alert("Enter Name");
                    
                    await addDoc(collection(db, "attendees"), {
                        eventId: eventId, name: name, studentId: sid, timestamp: Timestamp.now()
                    });
                    alert("Success!");
                    location.reload(); // Return to list
                };
            } else {
                statusBox.innerText = `❌ Too far away (${Math.round(dist)}m). Move closer to the venue.`;
                statusBox.classList.add('status-closed');
            }
        }, err => {
            statusBox.innerText = "GPS Error: " + err.message;
        }, { enableHighAccuracy: true });
    }
</script>
</body>
</html>
