<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mark Attendance</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    <h1 id="event-title">Loading Event...</h1>
    
    <div id="status-box" class="status">Initializing...</div>

    <div id="form-container" style="display:none;">
        <p>You are at the venue. Please sign in.</p>
        <input type="text" id="studentName" placeholder="Enter Full Name">
        <input type="text" id="studentID" placeholder="Student ID (Optional)">
        <button id="submitBtn">Submit Attendance</button>
    </div>
</div>

<script type="module">
    import { db, doc, getDoc, addDoc, collection, Timestamp, getDistanceFromLatLonInMeters } from './script.js';

    // 1. Get Event ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('eventId');
    
    const statusBox = document.getElementById("status-box");
    const formContainer = document.getElementById("form-container");
    const eventTitle = document.getElementById("event-title");

    let eventData = null;

    if (!eventId) {
        statusBox.innerText = "Invalid Link. No Event ID found.";
        statusBox.classList.add("error");
    } else {
        loadEvent();
    }

    // 2. Load Event Data from Firebase
    async function loadEvent() {
        try {
            const docRef = doc(db, "events", eventId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                eventData = docSnap.data();
                eventTitle.innerText = eventData.name;
                
                if(!eventData.isActive) {
                    statusBox.innerText = "This event is closed.";
                    statusBox.classList.add("error");
                    return;
                }

                // Event found, now check location
                checkLocation();
            } else {
                statusBox.innerText = "Event not found!";
                statusBox.classList.add("error");
            }
        } catch (error) {
            console.error(error);
            statusBox.innerText = "Error loading event.";
        }
    }

    // 3. Check User Location
    function checkLocation() {
        statusBox.innerText = "Requesting Location Access...";
        
        if (!navigator.geolocation) {
            statusBox.innerText = "Geolocation is not supported by your browser.";
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                
                // Calculate Distance
                const distance = getDistanceFromLatLonInMeters(
                    userLat, userLng, 
                    eventData.latitude, eventData.longitude
                );

                console.log(`Distance: ${distance} meters, Allowed: ${eventData.radius}`);

                if (distance <= eventData.radius) {
                    // Success!
                    statusBox.innerText = "Location Verified! You are within range.";
                    statusBox.classList.add("success");
                    statusBox.classList.remove("error");
                    formContainer.style.display = "block";
                } else {
                    // Fail
                    statusBox.innerText = `You are too far away (${Math.round(distance)}m). You must be within ${eventData.radius}m.`;
                    statusBox.classList.add("error");
                }
            },
            (error) => {
                statusBox.innerText = "Location Access Denied. Please allow location to mark attendance.";
                statusBox.classList.add("error");
            },
            { enableHighAccuracy: true } // Request best GPS accuracy
        );
    }

    // 4. Submit Attendance
    document.getElementById("submitBtn").addEventListener("click", async () => {
        const name = document.getElementById("studentName").value;
        const studentId = document.getElementById("studentID").value;

        if(!name) return alert("Please enter your name.");

        try {
            await addDoc(collection(db, "attendees"), {
                eventId: eventId,
                eventName: eventData.name,
                name: name,
                studentId: studentId,
                timestamp: Timestamp.now()
            });
            
            formContainer.innerHTML = "<h2>Attendance Marked! âœ…</h2>";
            statusBox.style.display = 'none';
        } catch (e) {
            alert("Error submitting. Try again.");
            console.error(e);
        }
    });
</script>
</body>
</html>
