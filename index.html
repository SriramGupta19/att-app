<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NITC Attendance</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .login-box { text-align: center; padding: 50px 20px; }
        .google-btn {
            background-color: #4285F4; color: white; border: none; padding: 15px 30px;
            font-size: 16px; border-radius: 5px; cursor: pointer; font-weight: bold;
        }
        .google-btn:hover { background-color: #357ae8; }
        .user-header { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #ddd; font-size: 0.9em; color: #555; }
        .logout { color: #c0392b; cursor: pointer; text-decoration: underline; font-weight: bold; }
        
        .status-done { background-color: #d1ecf1; color: #0c5460; }
        
        /* Auto-fill display style */
        .info-row {
            background: #fff;
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }
        .info-label { font-weight: bold; color: #555; }
        .info-val { font-weight: bold; color: #333; }
    </style>
</head>
<body>

<div class="container">

    <div id="view-login" class="hidden">
        <div class="login-box">
            <h2>NITC Attendance</h2>
            <p>Please sign in with your college email.</p>
            <p style="color:#e67e22; font-weight:bold;">(@nitc.ac.in only)</p>
            <br>
            <button id="googleBtn" class="google-btn">Sign in with Google</button>
            <p id="login-error" style="color:red; margin-top:20px; font-size:0.9em;"></p>
        </div>
    </div>

    <div id="view-app" class="hidden">
        
        <div class="user-header">
            <span id="user-email">...</span>
            <span class="logout" id="logoutBtn">Logout</span>
        </div>

        <div id="view-list">
            <h1>Live Events</h1>
            <p>Select an event to mark attendance:</p>
            <div id="live-events-list">Loading events...</div>
        </div>

        <div id="view-attendance" class="hidden">
            <button class="secondary" style="width:auto; margin-bottom:15px;" id="backBtn">← Back to List</button>
            
            <h2 id="event-title">Verifying...</h2>
            
            <div id="status-box" style="padding:15px; background:#f0f0f0; text-align:center; border-radius:5px; margin-bottom:15px;">
                Initializing...
            </div>

            <div id="form-container" class="hidden">
                <div class="info-row">
                    <span class="info-label">Name:</span>
                    <span class="info-val" id="display-name"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Roll No:</span>
                    <span class="info-val" id="display-roll"></span>
                </div>
                
                <button id="submitBtn" style="margin-top: 20px;">Confirm Attendance</button>
            </div>
        </div>
    </div>

</div>

<script type="module">
    import { 
        db, auth, collection, getDocs, query, where, addDoc, doc, getDoc, Timestamp, 
        getDistanceFromLatLonInMeters, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged 
    } from './script.js';

    // UI References
    const views = {
        login: document.getElementById('view-login'),
        app: document.getElementById('view-app'),
        list: document.getElementById('view-list'),
        attendance: document.getElementById('view-attendance')
    };

    let currentUser = null;
    let currentRollNo = "Unknown";

    // --- 1. AUTHENTICATION STATE OBSERVER ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            // Domain Check
            if (!user.email.endsWith('@nitc.ac.in')) {
                alert("ACCESS DENIED\n\nYou must use an @nitc.ac.in email address.");
                signOut(auth);
                return;
            }

            // --- ROLL NUMBER EXTRACTION LOGIC ---
            // Format: name_rollno@nitc.ac.in
            try {
                const parts = user.email.split('@')[0]; // get "name_rollno"
                const underscoreIndex = parts.indexOf('_');
                
                if (underscoreIndex !== -1) {
                    // Grab everything after the first underscore AND force Uppercase
                    currentRollNo = parts.substring(underscoreIndex + 1).toUpperCase();
                } else {
                    currentRollNo = "N/A"; // Handle faculty or non-standard emails
                }
            } catch (e) {
                console.error("Error parsing roll number", e);
                currentRollNo = "Error";
            }

            // Setup User Session
            currentUser = user;
            document.getElementById('user-email').innerText = user.email;
            document.getElementById('display-name').innerText = user.displayName;
            document.getElementById('display-roll').innerText = currentRollNo;
            
            showApp(); 

            // Handle Direct QR Code Links
            const urlParams = new URLSearchParams(window.location.search);
            const urlEventId = urlParams.get('id');
            if (urlEventId) {
                startAttendanceFlow(urlEventId);
            } else {
                loadLiveEvents();
            }

        } else {
            showLogin();
        }
    });

    // --- 2. BUTTON ACTIONS ---

    // LOGIN
    document.getElementById('googleBtn').addEventListener('click', () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider).catch((error) => {
            console.error("Login Error:", error);
            document.getElementById('login-error').innerText = error.message;
        });
    });

    // LOGOUT
    document.getElementById('logoutBtn').addEventListener('click', () => {
        signOut(auth).then(() => {
            window.location.href = window.location.pathname; // Clear URL params
        });
    });

    // BACK BUTTON
    document.getElementById('backBtn').addEventListener('click', () => {
        const newUrl = window.location.pathname;
        window.history.pushState({path: newUrl}, '', newUrl);

        views.attendance.classList.add('hidden');
        views.list.classList.remove('hidden');
        loadLiveEvents(); // Refresh list
    });

    // --- 3. HELPER FUNCTIONS ---
    function showLogin() {
        views.login.classList.remove('hidden');
        views.app.classList.add('hidden');
    }

    function showApp() {
        views.login.classList.add('hidden');
        views.app.classList.remove('hidden');
        views.list.classList.remove('hidden');
        views.attendance.classList.add('hidden');
    }

    // --- 4. CHECK IF ALREADY ATTENDED ---
    async function hasAttended(eventId) {
        const q = query(
            collection(db, "attendees"), 
            where("eventId", "==", eventId),
            where("email", "==", currentUser.email)
        );
        const snapshot = await getDocs(q);
        return !snapshot.empty; 
    }

    // --- 5. FETCH EVENTS (With Status Check) ---
    async function loadLiveEvents() {
        const listDiv = document.getElementById('live-events-list');
        listDiv.innerHTML = "<p>Refreshing list...</p>";

        try {
            const q = query(collection(db, "events"), where("isActive", "==", true));
            const snapshot = await getDocs(q);

            listDiv.innerHTML = "";
            if(snapshot.empty) {
                listDiv.innerHTML = "<p>No live events found.</p>";
                return;
            }

            for (const docSnap of snapshot.docs) {
                const data = docSnap.data();
                const attended = await hasAttended(docSnap.id);
                
                const div = document.createElement('div');
                div.className = 'event-card';
                
                let badge = '<span class="status-badge status-active">Live</span>';
                let clickAction = () => startAttendanceFlow(docSnap.id);
                
                if (attended) {
                    badge = '<span class="status-badge status-done">✅ Done</span>';
                }

                div.innerHTML = `<strong>${data.name}</strong> ${badge}`;
                div.onclick = clickAction;
                listDiv.appendChild(div);
            }
        } catch (e) {
            console.error(e);
            listDiv.innerHTML = "<p style='color:red'>Error loading events.</p>";
        }
    }

    // --- 6. ATTENDANCE LOGIC ---
    async function startAttendanceFlow(eventId) {
        views.list.classList.add('hidden');
        views.attendance.classList.remove('hidden');
        
        const statusBox = document.getElementById('status-box');
        const formContainer = document.getElementById('form-container');
        
        statusBox.innerText = "Loading Event Data...";
        statusBox.className = ""; 
        formContainer.classList.add('hidden');

        try {
            // A. Check if already attended first
            const alreadyAttended = await hasAttended(eventId);
            if (alreadyAttended) {
                statusBox.innerText = "✅ You have already marked attendance.";
                statusBox.classList.add('status-active');
                statusBox.style.backgroundColor = "#d4edda";
                statusBox.style.color = "#155724";
                
                // Fetch Event Name just for display
                const eSnap = await getDoc(doc(db, "events", eventId));
                if(eSnap.exists()) document.getElementById('event-title').innerText = eSnap.data().name;
                
                return; 
            }

            // B. Fetch Event Data
            const eventRef = doc(db, "events", eventId);
            const eventSnap = await getDoc(eventRef);

            if (!eventSnap.exists()) {
                statusBox.innerText = "Event not found.";
                statusBox.classList.add('status-closed');
                return;
            }

            const eventData = eventSnap.data();
            document.getElementById('event-title').innerText = eventData.name;

            if (!eventData.isActive) {
                statusBox.innerText = "This event is currently closed.";
                statusBox.classList.add('status-closed');
                return;
            }

            // C. GPS Check
            statusBox.innerText = "Checking GPS Location...";
            
            if(!navigator.geolocation) {
                statusBox.innerText = "GPS Error: Not Supported.";
                return;
            }

            navigator.geolocation.getCurrentPosition(pos => {
                const dist = getDistanceFromLatLonInMeters(
                    pos.coords.latitude, pos.coords.longitude,
                    eventData.latitude, eventData.longitude
                );
                
                if (dist <= eventData.radius) {
                    statusBox.innerText = "✅ Location Verified!";
                    statusBox.classList.add('status-active');
                    formContainer.classList.remove('hidden');

                    // Setup Submit Button
                    const submitBtn = document.getElementById('submitBtn');
                    const newBtn = submitBtn.cloneNode(true);
                    submitBtn.parentNode.replaceChild(newBtn, submitBtn);

                    newBtn.addEventListener('click', async () => {
                        newBtn.innerText = "Marking Attendance...";
                        newBtn.disabled = true;

                        try {
                            await addDoc(collection(db, "attendees"), {
                                eventId: eventId,
                                name: currentUser.displayName,
                                email: currentUser.email,
                                // ENSURES UPPERCASE ON SUBMIT
                                studentId: String(currentRollNo).toUpperCase(), 
                                timestamp: Timestamp.now()
                            });
                            alert("Success! Attendance Marked.");
                            document.getElementById('backBtn').click(); // Return to list
                        } catch(e) {
                            console.error(e);
                            alert("Error submitting: " + e.message);
                            newBtn.disabled = false;
                        }
                    });

                } else {
                    statusBox.innerText = `❌ You are ${Math.round(dist)}m away. Move closer to the venue.`;
                    statusBox.classList.add('status-closed');
                }
            }, (err) => {
                statusBox.innerText = "GPS Access Denied. Allow location permission.";
                statusBox.classList.add('status-closed');
            }, { enableHighAccuracy: true });

        } catch (e) {
            console.error(e);
            statusBox.innerText = "Error: " + e.message;
        }
    }
</script>
</body>
</html>
